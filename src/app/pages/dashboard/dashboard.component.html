<div class="dashboard">

  <div class="dashboard__header">
    <div>
      <h2 class="dashboard__title">Dashboard IoT – ESP32</h2>
      <p class="dashboard__subtitle">
        Telemetría desde MongoDB (temperatura y humedad).
      </p>
    </div>

    <button
      pButton
      type="button"
      label="Actualizar"
      icon="pi pi-refresh"
      class="p-button-rounded p-button-text dashboard__refresh"
      (click)="loadData()"
      [disabled]="loading">
    </button>
  </div>

  <div *ngIf="loading" class="dashboard__loading">
    <p-progressSpinner></p-progressSpinner>
    <p>Cargando datos...</p>
  </div>

  <div *ngIf="!loading" class="dashboard__grid">

    <!-- Resumen -->
    <p-card class="dashboard__card dashboard__card--summary">
      <ng-template pTemplate="title">
        Resumen
      </ng-template>

      <ng-template pTemplate="content">
        <div class="dashboard__summary">
          <div>
            <span class="dashboard__summary-label">Registros totales</span>
            <div class="dashboard__summary-value">
              {{ count ?? 0 }}
            </div>
          </div>

          <div *ngIf="lastUpdated">
            <span class="dashboard__summary-label">Última lectura</span>
            <div class="dashboard__summary-secondary">
              {{ lastUpdated | date:'short' }}
            </div>
          </div>
        </div>
      </ng-template>
    </p-card>

    <!-- Gráfica -->
    <p-card class="dashboard__card dashboard__card--chart">
      <ng-template pTemplate="title">
        Temperatura y humedad (últimas lecturas)
      </ng-template>

      <ng-template pTemplate="content">
        <div class="dashboard__chart-container" *ngIf="chartData">
          <p-chart
            type="line"
            [data]="chartData"
            [options]="chartOptions">
          </p-chart>
        </div>
        <p *ngIf="!telemetry.length" class="dashboard__empty">
          No hay datos suficientes para mostrar la gráfica.
        </p>
      </ng-template>
    </p-card>

    <!-- Tabla -->
    <p-card class="dashboard__card dashboard__card--table">
      <ng-template pTemplate="title">
        Lecturas recientes
      </ng-template>

      <ng-template pTemplate="content">
        <p-table
          [value]="telemetry"
          responsiveLayout="scroll"
          [paginator]="true"
          [rows]="10">

          <ng-template pTemplate="header">
            <tr>
              <th>Fecha (ESP)</th>
              <th>Temp (°C)</th>
              <th>Humedad (%)</th>
              <th>Device</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-row>
            <tr>
              <td>{{ row.ts_esp | date:'short' }}</td>
              <td>{{ row.temperature }}</td>
              <td>{{ row.humidity }}</td>
              <td>{{ row.device_id }}</td>
            </tr>
          </ng-template>

        </p-table>
      </ng-template>
    </p-card>

  </div>
</div>
