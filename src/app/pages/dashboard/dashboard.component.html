<div class="dashboard">

  <div class="dashboard__header">
    <div>
      <h2 class="dashboard__title">Dashboard IoT – ESP32</h2>
      <p class="dashboard__subtitle">
        Telemetría desde MongoDB (temperatura y humedad).
      </p>
    </div>

    <button
      pButton
      type="button"
      [label]="loading ? 'Actualizando...' : 'Actualizar'"
      [icon]="loading ? 'pi pi-spin pi-spinner' : 'pi pi-refresh'"
      class="dashboard__refresh p-button-rounded p-button-text"
      (click)="loadData()"
      [disabled]="loading">
    </button>
  </div>

  <div *ngIf="loading" class="dashboard__loading">
    <p-progressSpinner></p-progressSpinner>
    <p>Cargando datos...</p>
  </div>

  <div *ngIf="!loading" class="dashboard__grid">

    <!-- Resumen general -->
    <p-card class="dashboard__card dashboard__card--summary">
      <ng-template pTemplate="title">
        Resumen
      </ng-template>

      <ng-template pTemplate="content">
        <div class="dashboard__summary">
          <div>
            <span class="dashboard__summary-label">Registros totales</span>
            <div class="dashboard__summary-value">
              {{ count ?? 0 }}
            </div>
          </div>

          <!-- Usamos alias 'lt' para la última lectura -->
          <div *ngIf="lastTelemetry as lt">
            <span class="dashboard__summary-label">Última lectura</span>
            <div class="dashboard__summary-secondary">
              {{ (lt.ts_esp || lt.ts_server) | date:'short' }}
            </div>
          </div>
        </div>

        <!-- Métricas de la última lectura -->
        <div class="dashboard__metrics" *ngIf="lastTelemetry as lt">
          <div class="dashboard__metric">
            <span class="dashboard__metric-label">Temp actual</span>
            <div class="dashboard__metric-value dashboard__metric-value--temp">
              {{ lt.temperature }}°C
            </div>
          </div>

          <div class="dashboard__metric">
            <span class="dashboard__metric-label">Humedad actual</span>
            <div class="dashboard__metric-value dashboard__metric-value--hum">
              {{ lt.humidity }}%
            </div>
          </div>
        </div>
      </ng-template>
    </p-card>

    <!-- Métricas de intervalo -->
    <p-card class="dashboard__card dashboard__card--intervals">
      <ng-template pTemplate="title">
        Intervalos de envío (segundos)
      </ng-template>

      <ng-template pTemplate="content">
        <div *ngIf="avgIntervalSec !== null; else noIntervalData" class="dashboard__intervals">
          <div class="dashboard__interval-item">
            <span class="dashboard__summary-label">Intervalo actual</span>
            <div class="dashboard__interval-value">
              {{ currentIntervalSec }} s
            </div>
          </div>

          <div class="dashboard__interval-item">
            <span class="dashboard__summary-label">Promedio</span>
            <div class="dashboard__interval-value">
              {{ avgIntervalSec }} s
            </div>
          </div>

          <div class="dashboard__interval-item">
            <span class="dashboard__summary-label">Mínimo</span>
            <div class="dashboard__interval-value">
              {{ minIntervalSec }} s
            </div>
          </div>

          <div class="dashboard__interval-item">
            <span class="dashboard__summary-label">Máximo</span>
            <div class="dashboard__interval-value">
              {{ maxIntervalSec }} s
            </div>
          </div>
        </div>

        <ng-template #noIntervalData>
          <p class="dashboard__empty">Aún no hay suficientes lecturas para calcular intervalos.</p>
        </ng-template>
      </ng-template>
    </p-card>

    <!-- Gráfica -->
    <p-card class="dashboard__card dashboard__card--chart">
      <ng-template pTemplate="title">
        Temperatura y humedad (últimas lecturas)
      </ng-template>

      <ng-template pTemplate="content">
        <div class="dashboard__chart-container" *ngIf="chartData">
          <p-chart
            type="line"
            [data]="chartData"
            [options]="chartOptions">
          </p-chart>
        </div>
        <p *ngIf="!telemetry.length" class="dashboard__empty">
          No hay datos suficientes para mostrar la gráfica.
        </p>
      </ng-template>
    </p-card>

    <!-- Tabla -->
    <p-card class="dashboard__card dashboard__card--table">
      <ng-template pTemplate="title">
        Lecturas recientes
      </ng-template>

      <ng-template pTemplate="content">
        <p-table
          [value]="telemetry"
          responsiveLayout="scroll"
          [paginator]="true"
          [rows]="10"
          [rowHover]="true">

          <ng-template pTemplate="header">
            <tr>
              <th>Fecha (ESP)</th>
              <th>Temp (°C)</th>
              <th>Humedad (%)</th>
              <th>Δt (s)</th>
              <th>Device</th>
              <th></th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-row let-i="rowIndex">
            <tr>
              <td>{{ row.ts_esp || row.ts_server | date:'short' }}</td>
              <td>{{ row.temperature }}</td>
              <td>{{ row.humidity }}</td>

              <!-- Δt con respecto a la lectura anterior -->
              <td
                pTooltip="Segundos transcurridos desde la lectura anterior"
                tooltipPosition="top">
                <ng-container *ngIf="getDeltaSeconds(i) !== null; else firstRowDelta">
                  {{ getDeltaSeconds(i) }} s
                </ng-container>
                <ng-template #firstRowDelta>
                  –
                </ng-template>
              </td>

              <td>{{ row.device_id }}</td>

              <td class="dashboard__pill-cell">
                <p-tag
                  *ngIf="i === telemetry.length - 1"
                  value="Última"
                  severity="success"
                  rounded
                  class="dashboard__tag-live">
                </p-tag>
              </td>
            </tr>
          </ng-template>

        </p-table>
      </ng-template>
    </p-card>

  </div>
</div>
